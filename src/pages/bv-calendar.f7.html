<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">Behavioral Calendar</div>
      </div>
    </div>
    <div class="page-content">
      <div class="block-title">Choose kid</div>
      <div class="list">
        <ul @change="kidSelected">
          <li>
            <label class="item-radio item-content">
              <input type="radio" name="kid" value="Fyodor" checked="checked"/>
              <i class="icon icon-radio"></i>
              <div class="item-inner">
                <div class="item-title">Fyodor</div>
              </div>
            </label>
          </li>
          <li>
            <label class="item-radio item-content">
              <input type="radio" name="kid" value="Alyona"/>
              <i class="icon icon-radio"></i>
              <div class="item-inner">
                <div class="item-title">Alyona</div>
              </div>
            </label>
          </li>
        </ul>
      </div>
      <div class="block block-strong no-padding">
        <div id="inline-bv-calendar"></div>
      </div>
      <div id="points-data-table" class="data-table card">
        <div class="card-header {{#js_if "this.total > 0"}}bg-color-green{{else}}{{#js_if "this.total < 0"}}bg-color-red{{/js_if}}{{/js_if}}">
          <div class="data-table-title">{{kid}}'s total score: {{total}}</div>
        </div>
        <div class="card-content {{#js_if "this.total > 0"}}bg-color-green{{else}}{{#js_if "this.total < 0"}}bg-color-red{{/js_if}}{{/js_if}}">
          <table>
            <thead>
              <tr>
                <th class="label-cell">Description</th>
                <th class="numeric-cell">Points</th>
                <th class="numeric-cell">Time</th>
              </tr>
            </thead>
            <tbody>
              {{#each entries}}
              <tr>
                <td class="label-cell {{#js_if "this.score > 0"}}bg-color-green{{else}}bg-color-red{{/js_if}}">{{escape comment}}</td>
                <td class="numeric-cell {{#js_if "this.score > 0"}}bg-color-green{{else}}bg-color-red{{/js_if}}">{{score}}</td>
                <td class="numeric-cell {{#js_if "this.score > 0"}}bg-color-green{{else}}bg-color-red{{/js_if}}">{{ts}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
  import { DateTime } from "luxon"

  var component = null;
  var app;
  var $;

  function updateBVCalendarDots(year, month) {
    app.data.stitchClient.callFunction('getBVCalendarDots', [new Date(year, month)]).then(dots => {
      component.calendarInline.params.events = dots;
      component.calendarInline.update();
      console.log("Calendar dots were updated, "+ dots.length + " dots");
    }).catch(e => {
        console.error(e);
    });
  }

  function loadBVData(dt) {
    console.log("loadBVData():");
    console.log(component.calendarInline);
    var kid = $('input[name="kid"]:checked')[0].value;

    var tz = app.data.tz;

    const dayStartsAt = DateTime.fromJSDate(dt,{zone:tz}).startOf('day').toJSDate();
    const dayEndsAt   = DateTime.fromJSDate(dt,{zone:tz}).endOf('day').toJSDate();

    app.data.db.collection('bv_log').find(
      {
        ts: {"$gte": dayStartsAt, "$lte": dayEndsAt},
        child: kid
      },
      {sort: {ts:-1} }
    ).toArray().then(res => {
      component.$setState(
        {
          entries: res.map(function(el) {
            el.ts = DateTime.fromJSDate(el.ts,{zone:tz}).toLocaleString({ hour: '2-digit', minute: '2-digit', hour12: true });
            return el;
          }),
          kid: kid,
          total: res.length === 0 ? 0 : res.reduce((a,b) => ({ score: a.score + b.score })).score
        },
        function componentUpdateCallback() {console.log("component has been updated")});
    }).catch(e => {
        console.error(e);
    });
  }
  export default {
    data: function defaultData() {
      console.log("Returning default data");
      return {
        total: 0,
        entries: [],
      }
    },
    on: {
      pageInit: function(e, page) {
        console.log("pageInit()");
        component = this;
        app = component.$app;
        $ = component.$;

        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        var initialDate = DateTime.fromJSDate(new Date(),{zone:app.data.tz}).startOf('day').toJSDate();
        component.calendarInline = app.calendar.create({
          containerEl: '#inline-bv-calendar',
          value: [ initialDate ],
          events: [],
          renderToolbar: function() {
            return '<div class="toolbar calendar-custom-toolbar no-shadow">' +
              '<div class="toolbar-inner">' +
              '<div class="left">' +
              '<a href="#" class="link icon-only"><i class="icon icon-back"></i></a>' +
              '</div>' +
              '<div class="center"></div>' +
              '<div class="right">' +
              '<a href="#" class="link icon-only"><i class="icon icon-forward"></i></a>' +
              '</div>' +
              '</div>' +
              '</div>';
          },
          on: {
            init: function initBVCalendar(cal) {
              $('.calendar-custom-toolbar .center').text(monthNames[cal.currentMonth] + ', ' + cal.currentYear);
              $('.calendar-custom-toolbar .left .link').on('click', function() {
                component.calendarInline.prevMonth();
                app.data.stitchClient.callFunction('getBVCalendarDots', [new Date(cal.currentYear, cal.currentMonth)]).then(dots => {
                    cal.params.events = dots;
                    console.log("Calendar dots were updated, "+ dots.length + " dots");
                    cal.update();
                }).catch(e => {
                    console.error(e);
                });
              });
              $('.calendar-custom-toolbar .right .link').on('click', function() {
                component.calendarInline.nextMonth();
              });
              console.log("Calendar created");
            },
            monthYearChangeStart: function(cal) {
              $('.calendar-custom-toolbar .center').text(monthNames[cal.currentMonth] + ', ' + cal.currentYear);
              updateBVCalendarDots(cal.currentYear, cal.currentMonth);
            },
            dayClick: function(cal, dayEl, year, month, day) {
              console.log("dayClick()");
              loadBVData(DateTime.fromObject({
                year: year,
                month: month + 1,
                day: day,
                hour:0, minute: 0, second: 0,
                zone: app.data.tz
              }).toJSDate());
            },
          }
        });
        console.log("initial data load");
        updateBVCalendarDots(component.calendarInline.currentYear, component.calendarInline.currentMonth,);
        loadBVData(initialDate);
      },
    },
    methods: {
      kidSelected: function() {
        console.log("kidSelected()");
        console.log(this);
        loadBVData(component.calendarInline.getValue()[0])
      }
    },
  }
</script>
